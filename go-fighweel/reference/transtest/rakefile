$: << File.expand_path(File.dirname(__FILE__))

require 'pp'
require 'lib/geo'
include Geo
require 'rake/clean'

require 'lib/rakeutils'
include RakeUtils

require 'rake/clean'

SRC_DIR  = "src"
DST_DIR = "dst"

task :default => %w{compile}

# grule [DST_DIR,".json"] => [SRC_DIR, ".rb" ] do |t|
#      puts "Writing #{t.name}"
#      mkdir_p t.name.pathmap("%d")
#      txt = run_script(t.source, :json)
#      File.write(t.name, txt)
# end
#
# http://devblog.avdi.org/2014/04/25/rake-part-5-file-operations/

# mkdir if it doesn't exit

def mkdir_p? dir_name
    mkdir_p dir_name unless File.exist?(dir_name)
end

rule ".json" => [->(f){get_src_file(SRC_DIR,"rb",DST_DIR,"json")}] do |t|
     puts "Writing #{t.name}"
     mkdir_p? t.name.pathmap("%d") 
     txt = run_script(t.source, :json)
     File.write(t.name, txt)
end

src_files , dst_files = get_src_dst SRC_DIR, "rb", DST_DIR, "json" 

pp src_files
pp dst_files

task :compile => dst_files

CLEAN.include(dst_files)


